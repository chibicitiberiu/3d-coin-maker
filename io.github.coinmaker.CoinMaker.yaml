app-id: io.github.coinmaker.CoinMaker
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: coin-maker

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=xdg-data/coin-maker:create

modules:
  - name: coin-maker
    buildsystem: simple
    build-commands:
      # Install system dependencies first
      - pip3 install --no-build-isolation poetry
      
      # Install Node.js and pnpm
      - mkdir -p /tmp/nodejs
      - cd /tmp/nodejs
      - curl -L https://nodejs.org/dist/v20.18.0/node-v20.18.0-linux-x64.tar.xz | tar -xJ --strip-components=1
      - cp -r . /app/
      - npm install -g pnpm
      
      # Use the project's Makefile build system
      - make build-desktop MODE=release
      
      # Install the desktop application
      - mkdir -p ${FLATPAK_DEST}/bin
      - mkdir -p ${FLATPAK_DEST}/share/coin-maker
      - cp -r build/desktop ${FLATPAK_DEST}/share/coin-maker/
      - cp -r build/frontend ${FLATPAK_DEST}/share/coin-maker/
      - cp -r build/backend ${FLATPAK_DEST}/share/coin-maker/
      - cp -r build/external ${FLATPAK_DEST}/share/coin-maker/
      
      # Create launcher script
      - |
        cat > ${FLATPAK_DEST}/bin/coin-maker << 'EOF'
        #!/bin/bash
        cd /app/share/coin-maker/desktop
        export HMM_BINARY_PATH="/app/share/coin-maker/external/hmm/hmm"
        exec ./venv/bin/python desktop_main.py "$@"
        EOF
      - chmod +x ${FLATPAK_DEST}/bin/coin-maker
      
      # Install desktop files
      - mkdir -p ${FLATPAK_DEST}/share/applications
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps
      - mkdir -p ${FLATPAK_DEST}/share/metainfo
      - install -Dm644 io.github.coinmaker.CoinMaker.desktop ${FLATPAK_DEST}/share/applications/
      - if [ -f frontend/static/favicon.svg ]; then install -Dm644 frontend/static/favicon.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/io.github.coinmaker.CoinMaker.svg; fi
      - install -Dm644 io.github.coinmaker.CoinMaker.metainfo.xml ${FLATPAK_DEST}/share/metainfo/
      
    sources:
      - type: git
        url: .
        branch: HEAD